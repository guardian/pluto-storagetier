package com.gu.multimedia.storagetier.vidispine
import io.circe.syntax._
import io.circe.generic.auto._
import org.specs2.mutable.Specification

class MetadataValuesSpec extends Specification {
  val exampleParseValue = """{"item":[{"metadata":{"revision":"VX-13069,VX-10608,VX-10609,VX-10612,VX-10611,VX-10614,VX-10613","timespan":[{"field":[{"name":"mimeType","value":[{"value":"video/mp4","uuid":"5ce324a9-97a3-48cb-ad58-61edded0df1b","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"6c9f2a7a-da73-4731-8661-800d7ded83be","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"originalHeight","value":[{"value":"360","uuid":"9b021871-3f37-4533-a38a-e23024d50fad","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"130c48d5-9678-40a6-8507-ffeeed79e858","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"itemId","value":[{"value":"VX-1559","uuid":"68c636fc-2e0d-44fa-8735-bc9ec6008641","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"d2c4d8d3-4ffe-465d-b91e-09de5913977f","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"originalFilename","value":[{"value":"Resa moment Nobel prize.mp4","uuid":"f5e43288-344b-4e52-8d04-74b477e70ac6","user":"system","timestamp":"2021-10-11T11:24:34.023+0000","change":"VX-10612"}],"uuid":"b6298561-34d0-46ef-8ad7-06694e500602","user":"system","timestamp":"2021-10-11T11:24:34.023+0000","change":"VX-10612"},{"name":"mediaType","value":[{"value":"video","uuid":"fc569002-ec52-4035-9ae5-9038b4303403","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"1079acd5-468f-4b78-a332-cc875bd43f26","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"shapeTag","value":[{"value":"original","uuid":"61d55b47-fc03-499d-8939-c20f74bd9ca7","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"},{"value":"lowres","uuid":"d5a679ea-10f5-46d4-b694-edfda61e15d3","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"}],"uuid":"a4901747-9307-4ee0-a2eb-c7050b3c0301","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"},{"name":"representativeThumbnailNoAuth","value":[{"value":"/APInoauth/thumbnail/VX-2/VX-1559;version=0/1800@60?hash=bb7237ded285975f690995edf6a2f3c9","uuid":"39684fdd-28b5-461f-82a3-c4ebe2a519e8","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"}],"uuid":"c815b9b3-b15c-460f-83b4-5096bf7f9a7c","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"},{"name":"representativeThumbnail","value":[{"value":"/API/thumbnail/VX-2/VX-1559;version=0/1800@60","uuid":"27e153ad-82c8-4187-8b09-f5240133fb3a","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"}],"uuid":"5cece31d-1791-4c0c-97c6-6ef4c0f94911","user":"system","timestamp":"2021-10-11T11:24:58.731+0000","change":"VX-10613"},{"name":"title","value":[{"value":"Resa moment Nobel prize.mp4 (Fred_s_Front)","uuid":"8636df2b-3754-4178-aa3b-2a6622f6a581","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"uuid":"6507ef31-1257-4b5f-997d-3b2692cf1f27","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"},{"name":"created","value":[{"value":"2021-10-11T11:24:33.580Z","uuid":"970057c9-5cd4-4124-9edb-db45c60172d0","user":"system","timestamp":"2021-10-11T11:24:33.822+0000","change":"VX-10609"}],"uuid":"943378b9-c4a9-44d5-9efb-86cd431792ae","user":"system","timestamp":"2021-10-11T11:24:33.822+0000","change":"VX-10609"},{"name":"originalVideoCodec","value":[{"value":"h264","uuid":"6d88fbb9-2409-46d0-a8d5-67d6e4c7fd73","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"0cd77e19-69af-4c0c-a0d1-dd3a453bc826","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"originalFormat","value":[{"value":"mov,mp4,m4a,3gp,3g2,mj2","uuid":"470827c5-885f-4e36-b042-25e8700d1c98","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"efc2ad3c-f7d9-4fac-82aa-4fe72b3ca261","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"durationSeconds","value":[{"value":"5802.533","uuid":"4255f570-6500-4ea7-be22-d3cde918b509","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"62baf824-75c6-4d15-ab46-f3ac9f2c3350","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"originalAudioCodec","value":[{"value":"aac","uuid":"21bdbd07-4fbf-4c6c-b299-08ccf7492d73","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"85f55a2b-a66a-4e51-900c-bce931b0ad79","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"originalWidth","value":[{"value":"640","uuid":"df7204cf-abb3-4054-b781-f7bb1f661402","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"14d23bb0-40f8-4a88-8802-c6f327ae3a91","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"},{"name":"gnm_nearline_id","value":[{"value":"96c440e6-37f2-11ec-9140-b595a1474e09-0","uuid":"026b533d-5b93-45d1-8330-5c8c0cbc1785","user":"admin","timestamp":"2021-10-28T17:26:56.297+0000","change":"VX-13069"}],"uuid":"c2f857fa-fc2f-4bd0-a834-88dfe6799c8f","user":"admin","timestamp":"2021-10-28T17:26:56.297+0000","change":"VX-13069"},{"name":"durationTimeCode","value":[{"value":"92840528@16000","uuid":"b5715d84-581e-4087-89cd-d5b416198cec","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"uuid":"2f24ec0d-3ba9-4590-81ac-d3398f179ee3","user":"system","timestamp":"2021-10-11T11:24:33.982+0000","change":"VX-10611"}],"group":[{"name":"Asset","field":[{"name":"gnm_containing_projects","value":[{"value":"26","uuid":"901c631c-18a9-4c7b-b287-17d42f998509","user":"admin","timestamp":"2021-10-11T12:00:03.451+0000","change":"VX-10614"}],"uuid":"ec2265cd-2b0c-432d-9c46-33233a172b93","user":"admin","timestamp":"2021-10-11T12:00:03.451+0000","change":"VX-10614"},{"name":"gnm_category","value":[{"value":"Rushes","uuid":"9c128e52-cf8c-4c3c-b4c5-fbfd988a4cf7","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"uuid":"18e694db-6ed7-4683-a301-7c533a065f92","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"},{"name":"gnm_owner","value":[{"value":"0","uuid":"9399b756-5d9c-4049-a06f-8c7dc50f1bd4","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"uuid":"f1e73aff-ad30-4b98-819a-fb71889b265c","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"},{"name":"original_filename","value":[{"value":"/srv/Multimedia2/NextGenDev/Media Production/Assets/Fred_In_Bed/Fred_s_Front/andy_gallagher_gnm_int_fsdfsdfs/Resa moment Nobel prize.mp4","uuid":"22128d6c-27c5-4562-a3e2-b2d4149010fd","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"uuid":"2ccb744f-6cf7-4ca1-b4b9-866728f922e2","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"},{"name":"gnm_file_created","value":[{"value":"2021-10-11T11:20:39Z","uuid":"1b6c6c1f-bf1c-4cba-9c0e-2ec8e107fb9d","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"uuid":"a3836d87-f5ce-46b5-af20-3e109e3ae456","user":"admin","timestamp":"2021-10-11T11:24:33.700+0000","change":"VX-10608"}],"group":[],"uuid":"a991cf1e-9c23-4120-aa8e-c0c50bd04925","user":"admin","timestamp":"2021-10-11T12:00:03.451+0000","change":"VX-10614"}],"start":"-INF","end":"+INF"}]}}]}"""

  "ItemResponseSimplified" should {
    "be marshallable from a vidispine item server response" in {
      val maybeParsed = io.circe.parser.parse(exampleParseValue).flatMap(_.as[ItemResponseSimplified])
      maybeParsed must beRight
    }

    "allow metadata access" in {
      val maybeParsed = io.circe.parser.parse(exampleParseValue).flatMap(_.as[ItemResponseSimplified])
      maybeParsed must beRight

      val meta = maybeParsed.right.get
      meta.valuesForField("gnm_containing_projects",Some("Asset")).map(_.value).headOption must beSome("26")
      meta.valuesForField("gnm_file_created", Some("Asset")).map(_.value).headOption must beSome("2021-10-11T11:20:39Z")
      meta.valuesForField("representativeThumbnailNoAuth").map(_.value).headOption must beSome("/APInoauth/thumbnail/VX-2/VX-1559;version=0/1800@60?hash=bb7237ded285975f690995edf6a2f3c9")
      meta.valuesForField("hfghdfhfh").map(_.value).headOption must beNone
    }
  }
}
